define(["dojo/_base/lang","dojo/_base/array","esri/core/declare","esri/geometry/SpatialReference","esri/views/3d/externalRenderers"],function(k,m,n,p,h){var d=window.THREE,l={width:50,height:500,color:"#ff0000",loop:!1};return n([],{constructor:function(a,b,c){this.view=a;this.locations=b;k.mixin(l,c);this.origin=[0,0,0];b=[0,0,0];h.toRenderCoordinates(a,b,0,p.WGS84,this.origin,0,1);c=new d.Matrix4;c.fromArray(h.renderCoordinateTransformAt(this.view,b,a.spatialReference,Array(16)));this.rotation=
new d.Matrix4;this.rotation.extractRotation(c);this.counter=0},setup:function(a){this.renderer=new d.WebGLRenderer({context:a.gl});this.renderer.autoClear=!1;this.renderer.autoClearDepth=!1;this.renderer.autoClearColor=!1;this.renderer.autoClearStencil=!1;this.scene=new d.Scene;this.camera=new d.PerspectiveCamera;this._createObjects();this._createLights();a.resetWebGLState()},render:function(a){this._animate();this.renderer.resetGLState();this._updateCamera(a);this._updateLights(a);this.renderer.render(this.scene,
this.camera);(l.loop||1>this.counter)&&h.requestRender(this.view);a.resetWebGLState()},dispose:function(){this.object&&this.scene.remove(this.object)},_clearScene:function(){for(var a=this.scene.children.length-1;0<=a;a--)this.scene.remove(this.scene.children[a])},_createObjects:function(){this._clearScene();m.forEach(this.locations,k.hitch(this,function(a,b){var c=[0,0,0],f=[0,0,0],e=[a.x,a.y,a.height];h.toRenderCoordinates(this.view,[a.x,a.y,a.z||0],0,this.view.spatialReference,c,0,1);h.toRenderCoordinates(this.view,
e,0,this.view.spatialReference,f,0,1);c=new d.Vector3(c[0],c[1],c[2]);f=new d.Vector3(f[0],f[1],f[2]);e=new d.Vector3(this.origin[0],this.origin[1],this.origin[2]);c.sub(e);f.sub(e);var g=a.width,e=a.height,k=l.color,g=new d.CylinderGeometry(g,g,e,32);g.applyMatrix((new d.Matrix4).makeTranslation(0,e/2,0));g.applyMatrix((new d.Matrix4).makeRotationX(Math.PI/2));e=new d.MeshPhongMaterial({color:k});e=new d.Mesh(g,e);e.position.set(c.x,c.y,c.z);e.lookAt(f);e.index=b;this.scene.add(e)}))},_createLights:function(){this.directionalLight=
new d.DirectionalLight;this.scene.add(this.directionalLight);this.ambientLight=new d.AmbientLight;this.scene.add(this.ambientLight)},_animate:function(){this.counter=1>this.counter?this.counter+.01:l.loop?0:1;for(var a=Math.max(this.counter,1E-4),b=this.scene.children.length-1;0<=b;b--)this.scene.children[b].scale.set(1,1,a)},_updateCamera:function(a){a=a.camera;this.camera.projectionMatrix.fromArray(a.projectionMatrix);var b=this.origin;this.camera.position.set(a.eye[0]-b[0],a.eye[1]-b[1],a.eye[2]-
b[2]);this.camera.up.set(a.up[0],a.up[1],a.up[2]);this.camera.lookAt(new d.Vector3(a.center[0]-b[0],a.center[1]-b[1],a.center[2]-b[2]))},_updateLights:function(a){var b=a.sunLight.direction,c=a.sunLight.diffuse;this.directionalLight.color.setRGB(c.color[0],c.color[1],c.color[2]);this.directionalLight.intensity=c.intensity;this.directionalLight.position.set(b[0],b[1],b[2]);a=a.sunLight.ambient;this.ambientLight.color.setRGB(a.color[0],a.color[1],a.color[2]);this.ambientLight.intensity=a.intensity},
hitTest:function(a){var b=new d.Vector2;b.x=a.screenPoint.x/this.view.width*2-1;b.y=2*-(a.screenPoint.y/this.view.height)+1;a=new d.Raycaster;a.setFromCamera(b,this.camera);b=a.intersectObjects(this.scene.children);return 0<b.length?(b.sort(function(a,b){return a.distance-b.distance}),this.locations[b[0].object.index]):null}})});