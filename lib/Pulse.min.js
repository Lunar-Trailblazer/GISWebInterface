define(["dojo/_base/lang","dojo/_base/array","esri/core/declare","esri/geometry/SpatialReference","esri/views/3d/externalRenderers"],function(l,m,n,p,g){var d=window.THREE,h={width:50,height:500,color:"#ff0000",loop:!0};return n([],{constructor:function(a,c,b){this.view=a;this.locations=c;l.mixin(h,b);this.origin=[0,0,0];c=[0,0,0];g.toRenderCoordinates(a,c,0,p.WGS84,this.origin,0,1);b=new d.Matrix4;b.fromArray(g.renderCoordinateTransformAt(this.view,c,a.spatialReference,Array(16)));this.rotation=
new d.Matrix4;this.rotation.extractRotation(b);this.counter=0},setup:function(a){this.renderer=new d.WebGLRenderer({context:a.gl});this.renderer.autoClear=!1;this.renderer.autoClearDepth=!1;this.renderer.autoClearColor=!1;this.renderer.autoClearStencil=!1;this.scene=new d.Scene;this.camera=new d.PerspectiveCamera;this._createObjects();this._createLights();a.resetWebGLState()},render:function(a){this._animate();this.renderer.resetGLState();this._updateCamera(a);this._updateLights(a);this.renderer.render(this.scene,
this.camera);(h.loop||1>this.counter)&&g.requestRender(this.view);a.resetWebGLState()},dispose:function(){this.object&&this.scene.remove(this.object)},_clearScene:function(){for(var a=this.scene.children.length-1;0<=a;a--)this.scene.remove(this.scene.children[a])},_createObjects:function(){this._clearScene();m.forEach(this.locations,l.hitch(this,function(a,c){var b=[0,0,0],f=[0,0,0],e=[a.x,a.y,a.height+500];g.toRenderCoordinates(this.view,[a.x,a.y,a.height],0,this.view.spatialReference,b,0,1);g.toRenderCoordinates(this.view,
e,0,this.view.spatialReference,f,0,1);b=new d.Vector3(b[0],b[1],b[2]);f=new d.Vector3(f[0],f[1],f[2]);e=new d.Vector3(this.origin[0],this.origin[1],this.origin[2]);b.sub(e);f.sub(e);var k=h.color,e=new d.CircleGeometry(a.width,32),k=new d.MeshPhongMaterial({color:k,transparent:!0,opacity:1});k.depthWrite=!1;e=new d.Mesh(e,k);e.position.set(b.x,b.y,b.z);e.lookAt(f);e.index=c;this.scene.add(e)}))},_createLights:function(){this.directionalLight=new d.DirectionalLight;this.scene.add(this.directionalLight);
this.ambientLight=new d.AmbientLight;this.scene.add(this.ambientLight)},_animate:function(){var a=1;1>this.counter?(this.counter+=.01,a-=this.counter/1.5):this.counter=h.loop?0:1;for(var c=Math.max(this.counter,1E-4),b=this.scene.children.length-1;0<=b;b--){var d=this.scene.children[b];d.material&&(d.material.opacity=a);d.scale.set(c,c,1)}},_updateCamera:function(a){a=a.camera;this.camera.projectionMatrix.fromArray(a.projectionMatrix);var c=this.origin;this.camera.position.set(a.eye[0]-c[0],a.eye[1]-
c[1],a.eye[2]-c[2]);this.camera.up.set(a.up[0],a.up[1],a.up[2]);this.camera.lookAt(new d.Vector3(a.center[0]-c[0],a.center[1]-c[1],a.center[2]-c[2]))},_updateLights:function(a){var c=a.sunLight.direction,b=a.sunLight.diffuse;this.directionalLight.color.setRGB(b.color[0],b.color[1],b.color[2]);this.directionalLight.intensity=b.intensity;this.directionalLight.position.set(c[0],c[1],c[2]);a=a.sunLight.ambient;this.ambientLight.color.setRGB(a.color[0],a.color[1],a.color[2]);this.ambientLight.intensity=
a.intensity},hitTest:function(a){var c=a.target.container,b=new d.Vector2;b.x=a.screenPoint.x/c.clientWidth*2-1;b.y=2*-(a.screenPoint.y/c.clientHeight)+1;a=new d.Raycaster;a.setFromCamera(b,this.camera);b=a.intersectObjects(this.scene.children);return 0<b.length?(b.sort(function(a,b){return a.distance-b.distance}),this.locations[b[0].object.index]):null}})});